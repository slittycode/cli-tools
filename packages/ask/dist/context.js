/**
 * Project context injection via `ctx`
 *
 * Attempts to call `ctx generate` in the current directory to prepend
 * structured project context to every prompt. Fails silently â€” if ctx
 * isn't installed, not in a git repo, or errors out, the prompt is sent as-is.
 */
import { execSync } from 'child_process';
import { CTX_TIMEOUT_MS } from './config.js';
const CTX_HEADER = `\
<!-- PROJECT CONTEXT (generated by ctx) -->
`;
const CTX_FOOTER = `\
<!-- END PROJECT CONTEXT -->

`;
/**
 * Try to generate project context using the ctx CLI.
 * Returns the formatted block or null if ctx is unavailable/fails.
 */
export function getProjectContext(cwd) {
    try {
        // ctx generate emits markdown context for the current project
        const raw = execSync('ctx generate --format markdown 2>/dev/null', {
            cwd: cwd ?? process.cwd(),
            encoding: 'utf8',
            timeout: CTX_TIMEOUT_MS,
            stdio: ['pipe', 'pipe', 'pipe'],
        }).trim();
        if (!raw)
            return null;
        return `${CTX_HEADER}${raw}\n${CTX_FOOTER}`;
    }
    catch {
        return null;
    }
}
/**
 * Prepend project context to a prompt string.
 * Pass injectContext=false to skip (--no-context flag).
 */
export function buildPrompt(userPrompt, opts) {
    if (!opts.injectContext)
        return userPrompt;
    const ctx = getProjectContext(opts.cwd);
    if (!ctx)
        return userPrompt;
    return `${ctx}${userPrompt}`;
}
//# sourceMappingURL=context.js.map